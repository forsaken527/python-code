## nx 1.2.5
worker_processes  8;
pid        /var/run/tengine/nginx.pid;
events {
    worker_connections  40960;
}

http {
    include       mime.types;
    include	ngx_metric.conf;
    default_type  application/octet-stream;
    client_header_buffer_size 256k;
    large_client_header_buffers 4 256k;
    client_header_timeout 30;
    client_body_timeout 30;
    reset_timedout_connection on;
    client_max_body_size 20m;
    client_body_in_single_buffer on;

    #lua_package_path '/usr/local/tengine/lua/uuid4.lua';
    #init_by_lua ' uuid4 = require "uuid4" ';

    log_format  main  '$remote_addr | $server_addr $remote_user [$time_local] | "$request" | '
                      '$status | $body_bytes_sent | "$http_referer" $host | '
                      '"$http_user_agent" | "$http_x_forwarded_for" | $request_body | $request_time | $upstream_response_time';

    log_format  main1   '[$time_local] | $remote_user | $remote_addr | $http_x_forwarded_for | nginx | $server_addr:80 | $host | "$request" | '
                        '$status | $body_bytes_sent | $request_time | $upstream_response_time | "$http_referer" | "$http_user_agent" | $request_body | '
                        '$http_t_trace_id | $http_t_device_id | $http_t_next_span | $http_t_parent_id | $http_t_uid | | | | | |';

    log_format  json   '{"time_local":"$time_local",'
                        '"remote_user":"$remote_user",'
                        '"remote_addr":"$remote_addr",'
                        '"http_x_forwarded_for":"$http_x_forwarded_for",'
                        '"node_type":"nginx",'
                        '"ip:port":"$server_addr:80",'
                        '"host":"$host",'
                        '"request":"$request",'
                        '"status":"$status",'
                        '"body_bytes_sent":"$body_bytes_sent",'
                        '"request_time":"$request_time",'
                        '"upstream_response_time":"$upstream_response_time",'
                        '"http_referer":"$http_referer",'
                        '"http_user_agent":"$http_user_agent",'
                        '"request_body":"$request_body",'
                        '"http_t_trace_id":"$http_t_trace_id",'
                        '"http_t_device_id":"$http_t_device_id",'
                        '"http_t_next_span":"$http_t_next_span",'
                        '"http_t_parent_id":"$http_t_parent_id",'
                        '"http_t_uid":"$http_t_uid"}';

    access_log  /data/etouch/nginx/log/access.log  main;
    error_log   /data/etouch/nginx/log/error.log ;
    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  30;
    gzip  on;
    gzip_types text/plain application/x-javascript text/css application/xml text/javascript image/jpeg image/gif image/png application/json;
    gzip_comp_level 9;

####### cache ###########
#    proxy_temp_path /home/data0/proxy_temp_path;
#    proxy_cache_path /home/data0/proxy_cache_path levels=1:2 keys_zone=cache_one:2000m inactive=1d max_size=10g;
          
##########################################################
## upstream configure
##########################################################
    upstream pcadmin_suishenyun_net {
        server admin1.pc.freed.so:8080;
    }

    upstream pc_suishenyun_net {
        server api1.pc.freed.so:8080;
        server api1.pc.freed.so:8081;
	server api2.pc.freed.so:8080;
        server api2.pc.freed.so:8081;
        server api3.pc.freed.so:8080;
        server api3.pc.freed.so:8081;
        server api4.pc.freed.so:8080;
        server api4.pc.freed.so:8081;
        server api5.pc.freed.so:8080;
        server api5.pc.freed.so:8081;
        server api6.pc.freed.so:8080;
        server api6.pc.freed.so:8081;
        server api7.pc.freed.so:8080;
        server api7.pc.freed.so:8081;
        server 10.9.163.139:8081;
        server 10.9.163.139:8080;
        server 10.9.152.19:8081;
        server 10.9.152.19:8080;
# add
        server flume1.log.freed.so:8080;
        server flume1.log.freed.so:8081;
        server flume2.log.freed.so:8080;
        server flume2.log.freed.so:8081;
        server flume3.log.freed.so:8080;
        server flume3.log.freed.so:8081;
        server flume4.log.freed.so:8080;
        server flume4.log.freed.so:8081;

	check interval=3000 rise=8 fall=2 timeout=1000 type=http  default_down=false;
	check_keepalive_requests 100;
	check_http_send "HEAD /peacock/api/v2/skinlist?kind=2&os_type=1&versioncode=1&type_id=&page=1 HTTP/1.0\r\n\r\n";
	check_http_expect_alive http_2xx http_3xx ;
	keepalive 5000;
    }
##########################################################
## server configure
##########################################################
    server {
        listen       80;
        server_name  localhost 127.0.0.1  ;

        location /nxss {
            stub_status on;
            access_log  off;
        }
        error_page  404              /404.html;
        error_page   500 502 503 504  /50x.html;
        location = /404.html {
            root   html/;
        }
        location = /500.html {
            root   html/;
        }
    }

#### peacock
    server {
        listen     80 ;
        server_name  pc.suishenyun.net cdn.pc.suishenyun.net s.pc.suishenyun.net ;
        access_log  /data/etouch/nginx/log/pc.suishenyun.net.access.log-$year-$month-$day  main1;
        error_log   /data/etouch/nginx/log/pc.suishenyun.net.error.log ;

        location / {
	    #add_header Cache-Control 'no-store';
            #add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/ ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /peacock/api/notification/bar {
            add_header Cache-Control 'must-revalidate, max-age=1800';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/notification/bar ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
	location /lizhi/api/zhwnl {
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/zhwnl ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
        location /status {
            check_status;
        }
    }

    server {
        listen     443 ;
        server_name   v2-pc.suishenyun.net;
        access_log  /data/etouch/nginx/log/v2-pc.suishenyun.net.access.log-$year-$month-$day  main1;
        error_log   /data/etouch/nginx/log/v2-pc.suishenyun.net.error.log ;

        ssl on;
        ssl_certificate suishenyun.net.2016.crt;
        ssl_certificate_key   suishenyun.net.2016.key;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
#        ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!AESGCM;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        location / {
            #add_header Cache-Control 'no-store';
            #add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/ ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /peacock/api/notification/bar {
            add_header Cache-Control 'must-revalidate, max-age=1800';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/notification/bar ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /lizhi/api/zhwnl {
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/zhwnl ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
        location /status {
            check_status;
        }
    }

    server {
        listen     443 ;
        server_name v0-client-lz.rili.cn v2-v0-client-lz.rili.cn;
        access_log  /data/etouch/nginx/log/v0-client-lz.rili.cn.access.log  main;
        error_log   /data/etouch/nginx/log/v0-client-lz.rili.cn.error.log ;

        ssl on;
        ssl_certificate rili.cn.2016.crt;
        ssl_certificate_key   rili.cn.2016.key;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
#        ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!AESGCM;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        location / {
            #add_header Cache-Control 'no-store';
            #add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/ ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /lizhi/api/zhwnl {
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/zhwnl ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
    }

    server {
        listen     80 ;
        server_name v0-client-lz.rili.cn;
        access_log  /data/etouch/nginx/log/80-v0-client-lz.rili.cn.access.log-$year-$month-$day  main1;
        error_log   /data/etouch/nginx/log/80-v0-client-lz.rili.cn.error.log ;

        location / {
            #add_header Cache-Control 'no-store';
            #add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/ ;
            proxy_set_header Host $host;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /lizhi/api/zhwnl {
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/zhwnl ;
            proxy_set_header Host $host;
            proxy_set_header T-parent-id $http_t_next_span ;
            proxy_set_header T-next-span $http_t_next_span.1;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
#        location /lizhi/api/zhwnl/v2/daily {
#            proxy_buffer_size 64k;
#            proxy_buffers 32 32k;
#            proxy_busy_buffers_size 128k;
#            proxy_set_header X-Real-IP $remote_addr ;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
#            proxy_pass http://pc_suishenyun_net/peacock/api/zhwnl/v2/daily ;
#            proxy_set_header Host $host;
#proxy_http_version 1.1;
#proxy_set_header Connection "";
#           access_log  /data/etouch/nginx/log/80-v0-client-lz.rili.cn-lizhi-api-zhwnl-v2-daily-$year-$month-$day  main;
#        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
    }

    server {
        listen     80 ;
        server_name  games.etouch.cn;
        access_log  /data/etouch/nginx/log/games.etouch.cn.access.log  main;
        error_log   /data/etouch/nginx/log/games.etouch.cn.error.log ;

        location /peacock/games/ {
            add_header Cache-Control 'no-store';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/games/ ;
            proxy_set_header Host $host;
        }
        location /peacock/games/css/ {
            add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/games/css/ ;
            proxy_set_header Host $host;
        }
        location /peacock/games/js/ {
            add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/games/js/ ;
            proxy_set_header Host $host;
        }
        location /peacock/api/games {
            add_header Cache-Control 'must-revalidate, max-age=86400';
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/peacock/api/games ;
            proxy_set_header Host $host;
        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
    }

    server {
        listen     80 ;
        server_name  pcstats.suishenyun.net;
        access_log  /data/etouch/nginx/log/pcstats.suishenyun.net.access.log-$year-$month-$day  main;
        error_log   /data/etouch/nginx/log/pcstats.suishenyun.net.error.log ;

        location / {
            add_header Cache-Control 'no-store';
            #set_by_lua $uuid 'return uuid4.getUUID() ';
            #proxy_set_header uuid $uuid;
	    proxy_set_header nginx_time $time_local; 
	    client_body_buffer_size 2000K;
            proxy_buffer_size 256k;
            proxy_buffers 32 256k;
            proxy_busy_buffers_size 256k;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pc_suishenyun_net/ ;
            proxy_set_header Host $host;
        #    proxy_set_header Post-B $request_body;
proxy_http_version 1.1;
proxy_set_header Connection "";
        }
        location /do_not_delete {
            add_header Cache-Control 'must-revalidate, max-age=300';
            root html ;
        }
    }

    server {
        listen     80 ;
        server_name  pcadmin.suishenyun.net pcadmin1.suishenyun.net;
        access_log  /data/etouch/nginx/log/pcadmin.suishenyun.net.access.log  main;
        error_log   /data/etouch/nginx/log/pcadmin.suishenyun.net.error.log ;

        #include error.conf;
        location / {
            #include deny.conf;
            proxy_buffer_size 64k;
            proxy_buffers 32 32k;
            proxy_busy_buffers_size 128k;
            proxy_connect_timeout   18000;
            proxy_send_timeout      18000;
            proxy_read_timeout      18000;
            proxy_set_header X-Real-IP $remote_addr ;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;
            proxy_pass http://pcadmin_suishenyun_net/ ;
            proxy_set_header Host $host;
        }
        location /403 {
           auth_basic            "403";
           auth_basic_user_file  login.passwd;
           default_type 'text/plain';
           set $client_ip $remote_addr;
           set $command "sh /usr/local/nginx/conf/403.sh $client_ip";
           #content_by_lua 'ngx.say(ngx.var.command)'; 
           #content_by_lua 'os.execute(ngx.var.command)';
        }

    }

# log-dmp.suishenyun.cn
    server {
        listen     80 ;
        server_name  log-dmp.suishenyun.cn;
        error_log   /data/etouch/nginx/log/log-dmp.suishenyun.cn.error.log ;

        location /collect/event/log {
  	    proxy_set_header Host $host;
            proxy_pass $scheme://127.0.0.1:$server_port/success;
            client_body_buffer_size 2000K;
            access_log  /data/etouch/nginx/log/log-dmp.suishenyun.cn.access.log-$year-$month-$day  main;
        }
        location /success {
            return 200;
        }
        location /collect/ce/log {
            proxy_set_header Host $host;
            proxy_pass $scheme://127.0.0.1:$server_port/collect_ce_log;
            client_body_buffer_size 2000K;
            access_log  /data/etouch/nginx/log/log-dmp.suishenyun.cn.access.log-collect_ce_log-$year-$month-$day  main;
        }
        location /collect_ce_log {
            return 200;
        }
        location /collect/adtrack/view {
            proxy_set_header Host $host;
            proxy_pass $scheme://127.0.0.1:$server_port/collect_adtrack_view;
            client_body_buffer_size 2000K;
            access_log  /data/etouch/nginx/log/log-dmp.suishenyun.cn.access.log-collect_adtrack_view-$year-$month-$day  main;
        }
        location /collect_adtrack_view {
            return 200;
        }
        location /collect/adtrack/click {
            proxy_set_header Host $host;
            proxy_pass $scheme://127.0.0.1:$server_port/collect_adtrack_click;
            client_body_buffer_size 2000K;
            access_log  /data/etouch/nginx/log/log-dmp.suishenyun.cn.access.log-collect_adtrack_click-$year-$month-$day  main;
        }
        location /collect_adtrack_click {
            return 200;
        }
	location /track/api_ack {
	    proxy_set_header Host $host;
	    proxy_pass $scheme://127.0.0.1:$server_port/track_api_ack;
	    client_body_buffer_size 2000K;
	    access_log  /data/etouch/nginx/log/log-dmp.suishenyun.cn.access.log-track_api_ack-$year-$month-$day  main;
	}
	location /track_api_ack {
	    return 200;
	}
    }

###########################################################################
}
